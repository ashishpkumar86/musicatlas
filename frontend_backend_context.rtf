{\rtf1\ansi\ansicpg1252
\deff0{\fonttbl{\f0\fnil\fcharset0 Helvetica;}{\f1\fnil\fcharset0 Menlo;}}
\viewkind4\uc1\pard\sa200\sl276\slmult1\f0\fs24\lang1033\cf0
\b End-to-End Flow (v3 UI)\b0\line
- Home (/): links to /map, /data-check; main content is Spotify recs panel (login, top artists, add-artist flow).\line
- Spotify recs: button \f1 GET/HEAD /auth/spotify/login\f0 \u2192 OAuth \u2192 \f1 /auth/spotify/callback\f0 stores session \u2192 \f1 /auth/spotify/session\f0 checked \u2192 \f1 /spotify/top-artists?limit=50\f0 \u2192 \f1 POST /recs/albums/from-spotify\f0 returns album cards saved in session. Add-artist uses \f1 POST /recs/albums/add-artist\f0 and prepends results.\line
- Data-check: Spotify-only; shows session fields, top artists, sonic tags. TIDAL UI removed.\line
- Other routes present: /map, /map/[constellationId], /ingest (mock data).\line
\b Backend (FastAPI)\b0\line
- Entrypoint: \f1 app/main.py\f0 (CORS from env). Routers: auth, spotify, tidal, recs, taste, musicbrainz, enrichment.\line
- Auth/Spotify (\f1 app/routers/auth.py\f0): \f1 GET/HEAD /auth/spotify/login\f0 (PKCE redirect), \f1 GET /auth/spotify/callback\f0 (saves session), \f1 GET /auth/spotify/session\f0 (logged_in, user_id, display_name, scope, expires_at).\line
- MusicBrainz: when \f1 MB_SOURCE=db\f0 uses DB helpers in \f1 app/data/musicbrainz_db.py\f0. \f1 MB_DB_STATEMENT_TIMEOUT_MS\f0 (default 8000) applied per-connection to avoid hangs. \f1 search_artist_summary\f0 accepts \f1 name\f0 alias for \f1 query\f0.\line
- Recs (\f1 app/routers/recs.py\f0):\line
  \f1 GET /recs/albums\f0 \u2192 \f1 public.get_album_recs_v1\f0.\line
  \f1 POST /recs/albums/from-spotify\f0 body: [{name, popularity?, genres?}] \u2192 resolve to numeric MB IDs, upsert Spotify genres into \f1 artist_spotify_genres_v1\f0, call \f1 get_album_recs_v1\f0; stores rows in session.\line
  \f1 POST /recs/albums/add-artist\f0 body: {name} \u2192 resolve single MB ID \u2192 \f1 get_album_recs_v1\f0; prepends.\line
- Taste profile (\f1 app/routers/taste.py\f0): \f1 GET /taste/profile\f0 fetches/caches 50 album recs, maps artists to clusters via \f1 artist_cluster_profile_v1\f0, returns top 3 buckets + Other with labels from \f1 cluster_labels_spotify_v1\f0; optional \f1 validate=1\f0 adds totals check.\line
- Spotify client (\f1 app/clients/spotify_client.py\f0): app-token catalog search paced with min-interval and Retry-After backoff to avoid 429s.\line
- Sessions: in-memory \f1 SESSIONS\f0 cookie-keyed; album recs saved per session.\line
\b Frontend (Next.js, music-atlas-frontend-v3)\b0\line
- Home: \f1 src/app/page.tsx\f0; uses \f1 SpotifyRecsPanel\f0; links to map/data-check.\line
- Components: \f1 src/components/spotify-recs-panel.tsx\f0 (login button -> /auth/spotify/login, session check, fetch top artists, build album recs, add-artist input; copy "No, the world didnâ€™t run out of good new music."); \f1 src/components/source-login-panel.tsx\f0 (Spotify/TIDAL for other views).\line
- Data-check: \f1 src/app/data-check/page.tsx\f0 Spotify-only session/artists/tags.\line
- API base: \f1 NEXT_PUBLIC_API_BASE_URL\f0 (default http://localhost:8000) via \f1 src/lib/api.ts\f0.\line
- Asset: Spotify button uses \f1 public/Spotify_Full_Logo_RGB_Green.png\f0.\line
\b Environment (backend, .env at repo root)\b0\line
- \f1 MB_SOURCE=db\f0\line
- \f1 MB_DATABASE_URL=postgresql://musicatlas_app:Ob143Zen86!@127.0.0.1:5433/musicbrainz\f0\line
- \f1 MB_DB_STATEMENT_TIMEOUT_MS=8000\f0 (default)\line
- \f1 FRONTEND_URL=http://127.0.0.1:3000\f0\line
- \f1 CORS_ORIGINS=http://127.0.0.1:3000\f0\line
- \f1 SPOTIFY_CLIENT_ID=b70b5e7df2f24fc6a0596d91bfc0d5c4\f0\line
- \f1 SPOTIFY_CLIENT_SECRET=1e24a48c20ee4aee98328464fd804831\f0\line
- \f1 SPOTIFY_REDIRECT_URI=http://127.0.0.1:8000/auth/spotify/callback\f0\line
- (Optional) TIDAL_* envs remain but UI is Spotify-first.\line
- \f1 APP_ENV=dev\f0\line
\b Environment (frontend, music-atlas-frontend-v3/.env.local)\b0\line
- \f1 NEXT_PUBLIC_API_BASE_URL=http://127.0.0.1:8000\f0\line
\b SQL/init (run against MusicBrainz DB)\b0\line
- \f1 sql/2025-12-21-taste-profile.sql\f0 creates \f1 artist_spotify_genres_v1\f0 and views \f1 artist_cluster_profile_v1\f0, \f1 user_taste_clusters_v1\f0, \f1 cluster_labels_spotify_v1\f0.\line
\b DB Access (current setup)\b0\line
- SSH tunnel: \f1 ssh -i ~/.ssh/id_ed25519 -L 5433:localhost:5432 musicatlas86@34.179.133.224\f0\line
- Local psql: \f1 psql 'postgresql://musicatlas_app:Ob143Zen86!@localhost:5433/musicbrainz'\f0\line
\b Run locally\b0\line
- Backend: export envs (or use .env), then \f1 uvicorn app.main:app --reload\f0.\line
- Frontend: in \f1 music-atlas-frontend-v3\f0, \f1 npm install\f0 (once), then \f1 npm run dev\f0 (or \f1 npm run build && npm start\f0).\line
\b Functional checks\b0\line
- Backend: \f1 curl http://127.0.0.1:8000/health\f0 and \f1 /health/musicbrainz\f0 (accepts name alias). \f1 HEAD /auth/spotify/login\f0 should redirect like GET.\line
- Frontend: open http://127.0.0.1:3000.\line
- Add flow: enter artist \u2192 \f1 POST /recs/albums/add-artist\f0 \u2192 albums prepend.\line
- Spotify flow: login \u2192 \f1 /spotify/top-artists\f0 \u2192 \f1 /recs/albums/from-spotify\f0 \u2192 albums append; loader while building; MB lookups logged with timing.\line
- Taste flow: \f1 GET /taste/profile\f0 returns 3 buckets + Other; \f1 ?validate=1\f0 confirms total album count = recs length.\line
}
